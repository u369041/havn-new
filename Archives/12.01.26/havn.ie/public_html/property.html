<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HAVN.ie • Property</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --radius:18px;
      --maxW: 1180px;

      /* Stable hero height */
      --heroMin: 340;
      --heroMax: 520;
      --heroVw: 36; /* 36vw */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:var(--bg);
      overflow-x:hidden; /* ✅ fail-safe: never allow accidental horizontal scroll */
    }
    a{color:inherit}
    img{max-width:100%; display:block;} /* ✅ safe */
    .wrap{
      max-width:var(--maxW);
      margin:0 auto;
      padding:18px 14px 60px;
      overflow-x:hidden; /* ✅ fail-safe at container level too */
    }

    .topbar{
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; min-width:0;}
    .logo{
      width:28px;height:28px;border-radius:9px;
      background:linear-gradient(135deg,#2563eb,#0ea5e9);
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      box-shadow:0 10px 25px rgba(37,99,235,.25);
      flex:0 0 auto;
    }
    .brandTxt{display:flex; flex-direction:column; line-height:1.05; min-width:0;}
    .brandTxt strong{font-size:14px}
    .brandTxt span{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .topActions{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width:100%;
    }
    .btn.primary{
      background:#0f172a;
      color:#fff;
      border-color:#0f172a;
    }
    .btn:active{transform:translateY(1px)}

    .debug{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#0f172a;
      font-size:12px;
      opacity:.9;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      overflow:hidden;
      white-space:nowrap;
    }
    .debug b{font-weight:900}
    .debug .left{display:flex; gap:10px; align-items:center; min-width:0;}
    .debug .left span{min-width:0; overflow:hidden; text-overflow:ellipsis}
    .debug .right{color:var(--muted)}

    .headlineCard{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      max-width:100%;
      min-width:0;
      overflow:hidden; /* ✅ prevent accidental overflow from long strings */
    }
    .price{font-weight:900; font-size:20px; letter-spacing:-0.01em}
    h1{
      margin:4px 0 6px;
      font-size:30px;
      line-height:1.12;
      letter-spacing:-0.02em;
      max-width:100%;
      overflow-wrap:anywhere;
    }
    .subline{color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .dot{width:6px;height:6px;border-radius:50%; background:#94a3b8; display:inline-block}
    .actionsRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      max-width:100%;
    }
    .pill svg{width:16px;height:16px}
    .pill:active{transform:translateY(1px)}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:14px;
      align-items:start;
      max-width:100%;
    }
    /* ✅ CRITICAL: prevent grid children from forcing overflow */
    .grid > *{min-width:0;}

    @media (max-width: 820px){
      .grid{grid-template-columns:1fr;}
      h1{font-size:26px;}
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      max-width:100%;
      min-width:0;
    }

    .gallery{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      min-width:0;
      max-width:100%;
    }

    /* ✅ HERO */
    .hero{
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--line);
      position:relative;
      background:#0b1220;
      width:100%;
      max-width:100%;
      cursor:pointer;
      isolation:isolate; /* keeps blur contained */
      min-width:0;
    }
    .heroBg{
      position:absolute; inset:0;
      background-position:center center;
      background-size:cover;
      filter: blur(18px) brightness(.80) saturate(1.05);
      transform: scale(1.12);
      z-index:0;
      opacity:1;
    }
    .heroShade{
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.10), rgba(0,0,0,.40));
      z-index:1;
    }
    .hero img{
      position:relative;
      z-index:2;
      width:100% !important;
      height:100% !important;
      object-fit: cover !important;
      object-position:center center !important;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
      max-width:100% !important;
    }

    .heroTag{
      position:absolute;
      left:12px; top:12px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      box-shadow:0 10px 25px rgba(15,23,42,.10);
      pointer-events:none;
      z-index:3;
    }

    .noPhotoBig{
      display:grid;
      place-items:center;
      width:100%;
      max-width:100%;
      color:#94a3b8;
      font-weight:900;
      font-size:14px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#0b1220;
      min-width:0;
    }

    /* ✅ Horizontal thumbnails row */
    .thumbRail{
      display:flex;
      flex-direction:row;
      gap:10px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width: thin;
      max-width:100%;
      min-width:0;
    }
    .thumb{
      width:86px; height:62px;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
      cursor:pointer;
      flex:0 0 auto;
      background:#0b1220;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center center;
      display:block;
      opacity:.95;
    }
    .thumb.active{outline:3px solid rgba(37,99,235,.35); border-color:#bfdbfe;}

    .sideStack{display:flex; flex-direction:column; gap:14px; min-width:0;}
    .sideCard{padding:14px; min-width:0;}
    .sideTitle{font-weight:900; font-size:14px; margin:0 0 10px;}
    .glanceGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .glanceBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#fff;
      min-width:0;
    }
    .glanceLabel{color:var(--muted); font-size:12px; font-weight:800;}
    .glanceVal{margin-top:6px; font-size:16px; font-weight:900; overflow-wrap:anywhere;}
    .ctaBtn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      box-shadow:0 14px 35px rgba(37,99,235,.22);
    }
    .ghostBtn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
    }

    .pad{padding:14px;}
    .secTitle{margin:0 0 10px; font-weight:900; font-size:14px;}
    .text{color:#0f172a; font-size:14px; line-height:1.55; min-width:0;}
    .muted{color:var(--muted);}
    .chips{display:flex; flex-wrap:wrap; gap:8px; min-width:0;}
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .descRich p{margin:0 0 12px;}
    .descRich p:last-child{margin-bottom:0;}

    /* Map iframe */
    .mapFrame{
      width:100%;
      height:220px;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#f8fafc;
    }
    .mapHint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.35;
    }
    .mapActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Lightbox */
    .lb{
      position:fixed; inset:0;
      background:rgba(2,6,23,.82);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .lb.on{display:flex;}

    .lbInner{
      width:min(1180px, 96vw);
      height:min(80vh, 760px);
      background:#0b1220;
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      position:relative;
      display:grid;
      grid-template-columns: 110px 1fr;
    }
    @media (max-width: 820px){
      .lbInner{grid-template-columns: 1fr; grid-template-rows: auto 1fr;}
    }

    .lbRail{
      padding:12px;
      border-right:1px solid rgba(255,255,255,.10);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:rgba(255,255,255,.04);
    }
    @media (max-width: 820px){
      .lbRail{
        flex-direction:row;
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,.10);
      }
    }
    .lbThumb{
      width:86px;
      height:62px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      cursor:pointer;
      background:#0b1220;
      flex:0 0 auto;
    }
    .lbThumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center center;
      display:block;
      opacity:.95;
    }
    .lbThumb.active{outline:3px solid rgba(37,99,235,.45); border-color:rgba(191,219,254,.8);}

    .lbMain{
      position:relative;
      display:grid;
      place-items:center;
      background:#0b1220;
      overflow:hidden;
      min-width:0;
    }
    .lbImg{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background:#0b1220;
    }

    .lbTopBar{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .lbPill{
      pointer-events:auto;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.45);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }

    .lbNav{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .lbNavBtn{
      pointer-events:auto;
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:44px;height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(6px);
    }
    .lbNavBtn:hover{background:rgba(255,255,255,.16);}
    .lbPrev{left:12px;}
    .lbNext{right:12px;}
    .lbNavBtn svg{width:18px;height:18px}
  </style>
</head>

<body>
  <div class="wrap" id="wrap">

    <div class="topbar">
      <a class="brand" href="/index.html" aria-label="HAVN home">
        <div class="logo">⌂</div>
        <div class="brandTxt">
          <strong>havn.ie</strong>
          <span>Ireland's most curated property marketplace.</span>
        </div>
      </a>

      <div class="topActions">
        <a class="btn primary" href="/properties.html">Browse listings</a>
        <a class="btn" href="/login.html" id="loginBtn">Login</a>
      </div>
    </div>

    <div class="debug" id="debugBar">
      <div class="left">
        <b id="dbgVersion">vA.18-TRIPWIRE-LOCALHOST-OR-DEBUG</b>
        <span id="dbgSlug">slug=—</span>
      </div>
      <div class="right" id="dbgStatus">Loading…</div>
    </div>

    <div class="headlineCard" id="headlineCard">
      <div style="min-width:0;">
        <div class="price" id="priceTxt">—</div>
        <h1 id="titleTxt">Loading…</h1>
        <div class="subline">
          <span class="dot"></span>
          <span id="addrTxt" class="muted">—</span>
        </div>
      </div>

      <div class="actionsRow">
        <button class="pill" type="button" id="saveBtn" title="Save">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          Save
        </button>

        <button class="pill" type="button" id="shareBtn" title="Share">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <path d="M8.6 13.5l6.8 3.9M15.4 6.6L8.6 10.5"></path>
          </svg>
          Share
        </button>

        <button class="pill" type="button" id="contactBtn" title="Contact">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16v16H4z"></path>
            <path d="M22 6l-10 7L2 6"></path>
          </svg>
          Contact
        </button>
      </div>
    </div>

    <div class="grid" id="grid">
      <div class="leftStack" id="leftStack" style="display:flex; flex-direction:column; gap:14px; min-width:0;">
        <div class="card" id="galleryCard">
          <div class="gallery">
            <div>
              <div class="hero" id="heroBox">
                <div class="heroBg" id="heroBg"></div>
                <div class="heroShade"></div>
                <div class="heroTag">Listing</div>
                <img id="heroImg" alt="" decoding="async" />
              </div>
              <div class="noPhotoBig" id="noPhotoBig" style="display:none;">No photo</div>
            </div>

            <div class="thumbRail" id="thumbRail" aria-label="Listing photos"></div>
          </div>
        </div>

        <div class="card pad" id="descCard">
          <div class="secTitle">Description</div>
          <div class="text descRich" id="descTxt">—</div>
        </div>

        <div class="card pad" id="detailsCard">
          <div class="secTitle">Details</div>
          <div class="text muted" id="detailsTxt">—</div>
        </div>
      </div>

      <div class="sideStack" id="sideStack">
        <div class="card sideCard">
          <div class="sideTitle">At a glance</div>
          <div class="glanceGrid">
            <div class="glanceBox">
              <div class="glanceLabel">Type</div>
              <div class="glanceVal" id="glType">—</div>
            </div>
            <div class="glanceBox">
              <div class="glanceLabel">Status</div>
              <div class="glanceVal" id="glStatus">—</div>
            </div>
            <div class="glanceBox">
              <div class="glanceLabel">Beds</div>
              <div class="glanceVal" id="glBeds">—</div>
            </div>
            <div class="glanceBox">
              <div class="glanceLabel">Baths</div>
              <div class="glanceVal" id="glBaths">—</div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
            <button class="ctaBtn" type="button" id="contactSellerBtn">Contact seller</button>
            <button class="ghostBtn" type="button" id="backBtn">Back to listings</button>
          </div>
        </div>

        <div class="card sideCard">
          <div class="sideTitle">Highlights</div>
          <div class="text muted" id="highlightsTxt">No highlights listed.</div>
        </div>

        <div class="card sideCard">
          <div class="sideTitle">Features</div>
          <div class="chips" id="featuresChips"></div>
          <div class="text muted" id="featuresEmpty" style="display:none;">No features listed.</div>
        </div>

        <div class="card sideCard">
          <div class="sideTitle">Location</div>
          <div class="text muted" id="locTxt">—</div>

          <div style="margin-top:10px;">
            <iframe
              id="mapFrame"
              class="mapFrame"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              src="about:blank"
              title="Map"></iframe>

            <div class="mapActions">
              <a class="btn" id="openInMaps" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
            </div>

            <div class="mapHint" id="mapHint">—</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lb" id="lightbox" aria-hidden="true">
    <div class="lbInner" role="dialog" aria-label="Photo viewer">
      <div class="lbRail" id="lbRail"></div>

      <div class="lbMain">
        <div class="lbTopBar">
          <div class="lbPill" id="lbCount">1 / 1</div>
          <div class="lbPill" id="lbClose">Close ✕</div>
        </div>

        <div class="lbNav">
          <div class="lbNavBtn lbPrev" id="lbPrev" title="Previous">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"></path>
            </svg>
          </div>
          <div class="lbNavBtn lbNext" id="lbNext" title="Next">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 6l6 6-6 6"></path>
            </svg>
          </div>
        </div>

        <img class="lbImg" id="lbImg" alt="" decoding="async" />
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    // ✅ Debug-only tripwire toggle: localhost OR ?debug=1
    const DEBUG = (location.hostname === "localhost") || (new URLSearchParams(location.search).has("debug"));

    function qs(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function safeStr(v) {
      if (v === null || v === undefined) return "";
      return String(v);
    }

    function euro(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return "—";
      try {
        return n.toLocaleString("en-IE", { style: "currency", currency: "EUR", maximumFractionDigits: 0 });
      } catch {
        return "€" + Math.round(n).toLocaleString("en-IE");
      }
    }

    function setTxt(el, v, fallback="—") {
      if (!el) return;
      const s = safeStr(v).trim();
      el.textContent = s ? s : fallback;
    }

    function escapeHtml(s){
      return safeStr(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // blank lines => paragraphs; single newline => <br>
    function setParagraphs(el, raw, fallback="—"){
      if (!el) return;
      const text = safeStr(raw).trim();
      if (!text) { el.textContent = fallback; return; }

      const norm = text.replace(/\r\n/g,"\n");
      const blocks = norm.split(/\n\s*\n+/g).map(b=>b.trim()).filter(Boolean);

      const html = blocks.map(b=>{
        const lines = b.split("\n").map(l=>escapeHtml(l.trimEnd()));
        return `<p>${lines.join("<br>")}</p>`;
      }).join("");

      el.innerHTML = html || escapeHtml(fallback);
    }

    function titleCase(s) {
      return safeStr(s).toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    }

    function normalizeStatus(s) {
      const u = safeStr(s).toUpperCase().trim();
      if (!u) return "";
      if (u === "PUBLISHED") return "Published";
      if (u === "SUBMITTED") return "Submitted";
      if (u === "DRAFT") return "Draft";
      if (u === "REJECTED") return "Rejected";
      if (u === "ARCHIVED") return "Archived";
      return titleCase(u);
    }

    const API = "https://api.havn.ie";
    const slug = qs("slug") || "";
    $("#dbgSlug").textContent = "slug=" + (slug || "—");

    function dbgRight(txt) { $("#dbgStatus").textContent = txt; }

    async function fetchJson(path) {
      const url = API + path;
      const res = await fetch(url, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch {}
      return { ok: res.ok, status: res.status, url, json, text };
    }

    function unwrapProperty(payload) {
      if (!payload) return null;
      if (payload.property && typeof payload.property === "object") return payload.property;
      if (payload.data && typeof payload.data === "object") return payload.data;
      if (payload.item && typeof payload.item === "object") return payload.item;
      if (payload.result && typeof payload.result === "object") return payload.result;
      return payload;
    }

    function pickPhotos(p) {
      if (Array.isArray(p?.photos) && p.photos.length) return p.photos;
      if (Array.isArray(p?.images) && p.images.length) return p.images;
      if (Array.isArray(p?.photoUrls) && p.photoUrls.length) return p.photoUrls;
      return [];
    }

    function computeGlance(p) {
      const type =
        p?.propertyType ??
        p?.type ??
        p?.listingType ??
        p?.homeType ??
        p?.category ??
        "";

      const status =
        p?.listingStatus ??
        p?.status ??
        p?.state ??
        "";

      const beds =
        p?.bedrooms ??
        p?.beds ??
        p?.bedCount ??
        p?.numBeds ??
        null;

      const baths =
        p?.bathrooms ??
        p?.baths ??
        p?.bathCount ??
        p?.numBaths ??
        null;

      return {
        type: type ? titleCase(type) : "",
        status: normalizeStatus(status),
        beds: (beds === 0 || beds) ? String(beds) : "",
        baths: (baths === 0 || baths) ? String(baths) : "",
      };
    }

    function buildMapQuery(property) {
      const eir = safeStr(property?.eircode).trim();
      const parts = [
        property?.address1,
        property?.address2,
        property?.city,
        property?.county,
        property?.eircode
      ].filter(Boolean).map(safeStr);

      if (eir) return `${eir}, Ireland`;
      if (parts.length) return parts.join(", ");
      const loc = [property?.city, property?.county].filter(Boolean).map(safeStr).join(", ");
      return loc || "Ireland";
    }

    function renderMap(property) {
      const q = buildMapQuery(property);
      $("#mapFrame").src = `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;
      $("#openInMaps").href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
      $("#mapHint").textContent = "Map (Google Maps iframe).";
    }

    /* ✅ HERO height lock */
    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
    function computeHeroPx(){
      const root = getComputedStyle(document.documentElement);
      const min = Number(root.getPropertyValue("--heroMin")) || 340;
      const max = Number(root.getPropertyValue("--heroMax")) || 520;
      const vw  = Number(root.getPropertyValue("--heroVw")) || 36;
      const target = window.innerWidth * (vw / 100);
      return Math.round(clamp(target, min, max));
    }
    function forceHeroHeight(){
      const h = computeHeroPx();
      const hero = $("#heroBox");
      const noBig = $("#noPhotoBig");
      if (hero){
        hero.style.height = h + "px";
        hero.style.minHeight = h + "px";
        hero.style.maxHeight = h + "px";
      }
      if (noBig){
        noBig.style.height = h + "px";
        noBig.style.minHeight = h + "px";
        noBig.style.maxHeight = h + "px";
      }
    }
    window.addEventListener("resize", () => { forceHeroHeight(); tripwireCheck("resize"); });
    window.addEventListener("orientationchange", () => { setTimeout(() => { forceHeroHeight(); tripwireCheck("orientationchange"); }, 80); });

    /* Gallery + Lightbox */
    let G_PHOTOS = [];
    let G_INDEX = 0;

    function setHero(url){
      const heroImg = $("#heroImg");
      const heroBg  = $("#heroBg");

      heroImg.src = url;
      heroBg.style.backgroundImage = `url("${url}")`;

      // after load, re-assert sizing
      heroImg.addEventListener("load", () => {
        forceHeroHeight();
        setTimeout(forceHeroHeight, 30);
        setTimeout(() => tripwireCheck("heroImg.load"), 60);
      }, { once:true });

      forceHeroHeight();
      setTimeout(forceHeroHeight, 30);
    }

    function buildGallery(photos) {
      G_PHOTOS = Array.isArray(photos) ? photos : [];
      G_INDEX = 0;

      const rail = $("#thumbRail");
      rail.innerHTML = "";

      const hero = $("#heroBox");
      const noBig = $("#noPhotoBig");

      if (!G_PHOTOS.length) {
        hero.style.display = "none";
        rail.style.display = "none";
        noBig.style.display = "grid";
        forceHeroHeight();
        tripwireCheck("no-photos");
        return;
      }

      hero.style.display = "block";
      rail.style.display = "flex";
      noBig.style.display = "none";

      G_PHOTOS.forEach((url, i) => {
        const t = document.createElement("div");
        t.className = "thumb" + (i === 0 ? " active" : "");
        const im = document.createElement("img");
        im.src = url;
        im.alt = "";
        im.decoding = "async";
        t.appendChild(im);
        t.addEventListener("click", () => setActive(i));
        t.addEventListener("dblclick", () => openLightbox(i));
        rail.appendChild(t);
      });

      setHero(G_PHOTOS[0]);
      hero.addEventListener("click", () => openLightbox(G_INDEX));

      setTimeout(() => tripwireCheck("buildGallery.done"), 50);
    }

    function setActive(i) {
      G_INDEX = i;
      setHero(G_PHOTOS[i]);

      const thumbs = Array.from(document.querySelectorAll("#thumbRail .thumb"));
      thumbs.forEach((t, idx) => t.classList.toggle("active", idx === i));

      setTimeout(() => tripwireCheck("setActive"), 30);
    }

    function openLightbox(i) {
      if (!G_PHOTOS.length) return;
      G_INDEX = Math.max(0, Math.min(i, G_PHOTOS.length - 1));

      const lb = $("#lightbox");
      const rail = $("#lbRail");
      rail.innerHTML = "";

      G_PHOTOS.forEach((url, idx) => {
        const t = document.createElement("div");
        t.className = "lbThumb" + (idx === G_INDEX ? " active" : "");
        const im = document.createElement("img");
        im.src = url;
        im.alt = "";
        im.decoding = "async";
        t.appendChild(im);
        t.addEventListener("click", () => lbSet(idx));
        rail.appendChild(t);
      });

      lbSet(G_INDEX, true);
      lb.classList.add("on");
      lb.setAttribute("aria-hidden", "false");
    }

    function lbSet(i, skipScroll=false){
      if (!G_PHOTOS.length) return;
      G_INDEX = Math.max(0, Math.min(i, G_PHOTOS.length - 1));
      $("#lbImg").src = G_PHOTOS[G_INDEX];
      $("#lbCount").textContent = `${G_INDEX + 1} / ${G_PHOTOS.length}`;

      const thumbs = Array.from(document.querySelectorAll("#lbRail .lbThumb"));
      thumbs.forEach((t, idx) => t.classList.toggle("active", idx === G_INDEX));

      if (!skipScroll){
        const active = thumbs[G_INDEX];
        if (active) active.scrollIntoView({ block:"nearest", inline:"nearest" });
      }
    }

    function closeLightbox() {
      $("#lightbox").classList.remove("on");
      $("#lightbox").setAttribute("aria-hidden", "true");
    }
    $("#lbClose").addEventListener("click", closeLightbox);
    $("#lbPrev").addEventListener("click", (e)=>{ e.stopPropagation(); lbSet(G_INDEX - 1); });
    $("#lbNext").addEventListener("click", (e)=>{ e.stopPropagation(); lbSet(G_INDEX + 1); });

    $("#lightbox").addEventListener("click", (e) => {
      if (e.target && e.target.id === "lightbox") closeLightbox();
    });

    window.addEventListener("keydown", (e) => {
      if (!$("#lightbox").classList.contains("on")) return;
      if (e.key === "Escape") closeLightbox();
      if (e.key === "ArrowRight") lbSet(G_INDEX + 1);
      if (e.key === "ArrowLeft") lbSet(G_INDEX - 1);
    });

    function render(property, meta) {
      setTxt($("#priceTxt"), euro(property?.price ?? property?.askingPrice ?? property?.rent));
      setTxt($("#titleTxt"), property?.title ?? property?.headline ?? "Untitled listing");

      const addrBits = [property?.address1, property?.address2, property?.city, property?.county, property?.eircode].filter(Boolean);
      setTxt($("#addrTxt"), addrBits.join(" • "));

      setParagraphs($("#descTxt"), property?.description ?? property?.desc ?? "", "No description provided.");
      setTxt($("#detailsTxt"), property?.details ?? "", "No details provided.");

      const highlights = Array.isArray(property?.highlights) ? property.highlights : [];
      setTxt($("#highlightsTxt"), highlights.length ? highlights.join(" • ") : "", "No highlights listed.");

      const features =
        Array.isArray(property?.features) ? property.features :
        (typeof property?.features === "string" ? [property.features] : []);

      const chips = $("#featuresChips");
      chips.innerHTML = "";
      if (features.length) {
        $("#featuresEmpty").style.display = "none";
        features.forEach(f => {
          const d = document.createElement("div");
          d.className = "chip";
          d.textContent = safeStr(f);
          chips.appendChild(d);
        });
      } else {
        $("#featuresEmpty").style.display = "block";
      }

      const loc = [property?.city, property?.county, property?.eircode].filter(Boolean).join(" • ");
      setTxt($("#locTxt"), loc, "Location not provided.");

      const g = computeGlance(property);
      setTxt($("#glType"), g.type, "—");
      setTxt($("#glStatus"), g.status, "—");
      setTxt($("#glBeds"), g.beds, "—");
      setTxt($("#glBaths"), g.baths, "—");

      buildGallery(pickPhotos(property));
      renderMap(property);

      dbgRight(meta?.loadedFrom ? `Loaded (${meta.loadedFrom})` : "Loaded");

      forceHeroHeight();
      setTimeout(forceHeroHeight, 30);
      setTimeout(forceHeroHeight, 200);

      setTimeout(() => tripwireCheck("render.done"), 60);
    }

    // Buttons
    $("#backBtn").addEventListener("click", () => (window.location.href = "/properties.html"));
    $("#contactSellerBtn").addEventListener("click", () => alert("Contact flow coming next (email/phone)."));
    $("#contactBtn").addEventListener("click", () => $("#contactSellerBtn").click());
    $("#shareBtn").addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(window.location.href); alert("Link copied ✅"); }
      catch { prompt("Copy link:", window.location.href); }
    });
    $("#saveBtn").addEventListener("click", () => alert("Save flow coming next (requires account)."));

    /* ===========================
       ✅ DEBUG-ONLY TRIPWIRE
       Runs only on localhost OR ?debug=1
       =========================== */
    function rect(el){ return el ? el.getBoundingClientRect() : null; }

    function tripwireCheck(reason="manual"){
      if (!DEBUG) return;

      const wrap = $("#wrap");
      const galleryCard = $("#galleryCard");
      const hero = $("#heroBox");
      const heroImg = $("#heroImg");

      const wrapR = rect(wrap);
      const cardR = rect(galleryCard);
      const heroR = rect(hero);

      const issues = [];

      // Horizontal scroll detection
      const docScrollW = document.documentElement.scrollWidth;
      const docClientW = document.documentElement.clientWidth;
      if (docScrollW > docClientW + 2){
        issues.push(`Horizontal overflow: scrollWidth(${docScrollW}) > clientWidth(${docClientW})`);
      }

      // Hero/card outside wrap
      if (wrapR && heroR){
        if (heroR.left < wrapR.left - 1) issues.push(`Hero extends left of wrap by ${(wrapR.left - heroR.left).toFixed(1)}px`);
        if (heroR.right > wrapR.right + 1) issues.push(`Hero extends right of wrap by ${(heroR.right - wrapR.right).toFixed(1)}px`);
      }
      if (wrapR && cardR){
        if (cardR.right > wrapR.right + 1) issues.push(`Gallery card extends right of wrap by ${(cardR.right - wrapR.right).toFixed(1)}px`);
      }

      // Hero image bigger than hero box
      if (hero && heroImg){
        const hw = hero.clientWidth;
        const iw = heroImg.getBoundingClientRect().width;
        if (iw > hw + 2) issues.push(`Hero IMG wider than hero box: img(${iw.toFixed(1)}) > hero(${hw})`);
      }

      // Any issues => warn + include key widths
      if (issues.length){
        console.groupCollapsed(`%cHAVN TRIPWIRE ⚠️ (${reason})`, "color:#ef4444;font-weight:900;");
        console.log("URL:", location.href);
        console.log("Viewport:", { clientW: docClientW, clientH: document.documentElement.clientHeight, scrollW: docScrollW });
        console.log("Wrap:", wrapR);
        console.log("GalleryCard:", cardR);
        console.log("Hero:", heroR);
        if (heroImg){
          console.log("HeroImg:", {
            rect: heroImg.getBoundingClientRect(),
            natural: { w: heroImg.naturalWidth, h: heroImg.naturalHeight }
          });
        }
        issues.forEach(x => console.warn(x));
        console.groupEnd();
      }
    }

    function enableTripwireObservers(){
      if (!DEBUG) return;
      // Check after load & after images settle
      window.addEventListener("load", () => {
        tripwireCheck("window.load");
        setTimeout(() => tripwireCheck("window.load+500ms"), 500);
        setTimeout(() => tripwireCheck("window.load+1500ms"), 1500);
      });

      // ResizeObserver catches element-driven layout changes
      if ("ResizeObserver" in window){
        const ro = new ResizeObserver(() => tripwireCheck("ResizeObserver"));
        ["wrap","grid","galleryCard","heroBox","thumbRail","headlineCard"].forEach(id => {
          const el = document.getElementById(id);
          if (el) ro.observe(el);
        });
      }
    }

    // Boot
    (async function boot() {
      forceHeroHeight();
      enableTripwireObservers();

      if (!slug) {
        dbgRight("Missing slug");
        $("#titleTxt").textContent = "Missing slug";
        $("#descTxt").textContent = "Open a listing via property.html?slug=…";
        tripwireCheck("missing-slug");
        return;
      }

      dbgRight("Loading…");
      const r1 = await fetchJson(`/api/properties/${encodeURIComponent(slug)}`);
      if (r1.ok && r1.json) {
        const prop = unwrapProperty(r1.json);
        if (prop && typeof prop === "object") {
          render(prop, { loadedFrom: `/api/properties/${slug}` });
          return;
        }
      }

      const r2 = await fetchJson(`/api/properties/latest`);
      if (r2.ok && r2.json) {
        const payload = r2.json;
        const items = Array.isArray(payload) ? payload : (Array.isArray(payload.items) ? payload.items : []);
        const hit = items.find(x => safeStr(x?.slug) === slug);
        if (hit) {
          render(hit, { loadedFrom: `/api/properties/latest (matched slug)` });
          return;
        }
      }

      dbgRight(`Load failed (${r1.status})`);
      $("#titleTxt").textContent = "Listing not found";
      $("#descTxt").textContent = "This listing may be unpublished or the link is incorrect.";
      $("#detailsTxt").textContent = r1.text || "";
      try { renderMap({ eircode:"Ireland" }); } catch {}
      forceHeroHeight();
      tripwireCheck("load-failed");
    })();
  </script>
</body>
</html>
