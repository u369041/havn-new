<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HAVN.ie • Property moderation</title>

  <style>
    :root{
      --bg:#f6f8fc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --shadow:0 12px 30px rgba(15,23,42,.08); --radius:18px;
      --blue:#2563eb; --navy:#0f172a; --green:#16a34a; --red:#ef4444; --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 60px;}

    .topRow{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:12px;}
    h1{margin:6px 0 2px;font-size:22px;letter-spacing:-.02em}
    .sub{color:var(--muted);font-size:13px;font-weight:800}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    .btn{
      border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:999px;cursor:pointer;
      font-weight:900;font-size:13px;box-shadow:0 10px 25px rgba(15,23,42,.06);
      text-decoration:none;display:inline-flex;align-items:center;gap:8px;user-select:none;white-space:nowrap;
    }
    .btn.blue{background:var(--blue);color:#fff;border-color:var(--blue);}
    .btn.good{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.25);}
    .btn.bad{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25);}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1.55fr 0.9fr;gap:14px;align-items:start;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}

    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .cardBd{padding:14px;}

    .hero{
      width:100%;height:420px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#eef2ff,#eff6ff);
      display:block;object-fit:cover;
    }
    @media (max-width:980px){.hero{height:300px;}}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .title{font-size:18px;font-weight:1000;margin:10px 0 2px;letter-spacing:-.02em;}
    .addr{color:var(--muted);font-size:13px;font-weight:800;margin:0 0 10px;}

    .chip{
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid var(--line);background:#fff;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .chip .mono{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:380px;}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.g{background:var(--green)} .dot.y{background:var(--amber)} .dot.r{background:var(--red)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    .kv{display:grid;grid-template-columns:150px 1fr;gap:8px 12px;margin-top:10px;font-size:13px;}
    .k{color:var(--muted);font-weight:900}
    .v{color:var(--ink);font-weight:800;word-break:break-word}

    .thumbs{margin-top:12px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    @media (max-width:980px){.thumbs{grid-template-columns:repeat(3,minmax(0,1fr));}}
    @media (max-width:520px){.thumbs{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .t{border:1px solid var(--line);border-radius:14px;overflow:hidden;height:110px;background:#0b1220;}
    .t img{width:100%;height:100%;object-fit:cover;display:block;}

    .stats{margin-top:12px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    @media (max-width:980px){.stats{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .stat{border:1px solid var(--line);border-radius:14px;background:#fff;padding:10px 12px;box-shadow:0 10px 25px rgba(15,23,42,.06);}
    .stat .lbl{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px;}
    .stat .val{font-weight:1000;font-size:15px;letter-spacing:-.01em;}

    .section{margin-top:14px;}
    .secTitle{font-weight:1000;font-size:13px;margin:0 0 8px;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chip2{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:12px;color:var(--muted);}

    .textBox{
      border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px 12px;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      color:#0f172a;font-weight:800;font-size:13px;line-height:1.55;
      white-space:pre-wrap;word-break:break-word;min-height:46px;
    }

    .mapWrap{border-radius:14px;border:1px solid #dbeafe;overflow:hidden;background:linear-gradient(180deg,#eef2ff,#eff6ff);box-shadow:0 10px 25px rgba(15,23,42,.06);}
    .mapTop{padding:10px 12px;border-bottom:1px solid rgba(37,99,235,.15);display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.65);}
    .mapTop .label{font-weight:1000;font-size:12px;color:#0f172a}
    .mapTop .small{font-weight:900;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%;}
    .mapIfr{width:100%;height:250px;border:0;display:block;background:#eef2ff;}

    .note{color:var(--muted);font-weight:900;font-size:12px;line-height:1.4;}

    .err{
      margin-top:12px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);
      border-radius:var(--radius);padding:12px 14px;display:none;
    }
    .err h3{margin:0 0 6px;font-size:14px}
    .err .msg{color:#991b1b;font-weight:900;font-size:13px}
    .err pre{
      margin:8px 0 0;padding:10px 12px;border-radius:14px;background:#0b1220;color:#e5e7eb;
      overflow:auto;font-size:12px;line-height:1.45;border:1px solid rgba(255,255,255,.10);white-space:pre-wrap;word-break:break-word;
    }

    .toast{
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
      background:#0b1220;color:#fff;padding:12px 14px;border-radius:999px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);font-weight:1000;font-size:13px;
      opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:9999;
    }
    .toast.show{opacity:1;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topRow">
      <div>
        <h1>Property moderation</h1>
        <div class="sub">Approve / Reject + full listing preview. “View public” opens <span class="mono">property.html</span>.</div>
      </div>

      <div class="actions">
        <button class="btn" id="backBtn" type="button">← Back</button>
        <button class="btn blue" id="viewPublicBtn" type="button" disabled>View public</button>
        <button class="btn good" id="approveBtn" type="button" disabled>Approve</button>
        <button class="btn bad" id="rejectBtn" type="button" disabled>Reject</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <img id="hero" class="hero" alt="" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23eef2ff'/%3E%3C/svg%3E" />

        <div class="cardBd">
          <div class="title" id="ttl">—</div>
          <div class="addr" id="addr">—</div>

          <div class="row" style="margin-bottom:10px">
            <span class="chip" id="statusChip"><span class="dot y"></span><span id="statusText">—</span></span>
            <span class="chip" id="typeChip">type: —</span>
            <span class="chip" id="saleChip">listing: —</span>
            <span class="chip mono" id="idChip">id: —</span>
            <span class="chip mono" id="slugChip">slug: —</span>
          </div>

          <div class="stats">
            <div class="stat"><div class="lbl">Price</div><div class="val" id="priceVal">—</div></div>
            <div class="stat"><div class="lbl">Bedrooms</div><div class="val" id="bedsVal">—</div></div>
            <div class="stat"><div class="lbl">Bathrooms</div><div class="val" id="bathsVal">—</div></div>
            <div class="stat"><div class="lbl">Size</div><div class="val" id="sizeVal">—</div></div>
          </div>

          <div class="section">
            <div class="secTitle">Google Maps</div>
            <div class="mapWrap">
              <div class="mapTop">
                <div class="label">Map preview</div>
                <div class="small" id="mapQueryLabel">—</div>
              </div>
              <iframe id="mapFrame" class="mapIfr" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="about:blank"></iframe>
            </div>
            <div class="note" style="margin-top:8px;">Eircode-first. Falls back to address if Eircode missing.</div>
          </div>

          <div class="section">
            <div class="secTitle">Highlights</div>
            <div class="chips" id="highlightsChips"></div>
            <div class="note" id="highlightsEmpty" style="display:none;">No highlights provided.</div>
          </div>

          <div class="section">
            <div class="secTitle">Features</div>
            <div class="chips" id="featuresChips"></div>
            <div class="note" id="featuresEmpty" style="display:none;">No features provided.</div>
          </div>

          <div class="section">
            <div class="secTitle">Description</div>
            <div class="textBox" id="descBox">—</div>
          </div>

          <div class="section">
            <div class="secTitle">Details</div>
            <div class="textBox" id="detailsBox">—</div>
          </div>

          <div class="section">
            <div class="secTitle">Photos</div>
            <div class="thumbs" id="thumbs"></div>
          </div>

          <div class="section">
            <div class="secTitle">Admin meta</div>
            <div class="kv">
              <div class="k">Created</div><div class="v" id="created">—</div>
              <div class="k">Updated</div><div class="v" id="updated">—</div>
              <div class="k">Load via</div><div class="v mono" id="loadVia">—</div>
              <div class="k">Moderate via</div><div class="v mono" id="modVia">—</div>
            </div>
          </div>

          <div class="err" id="errBox">
            <h3>Load / action failed</h3>
            <div class="msg" id="errMsg">Something went wrong.</div>
            <pre id="errPre"></pre>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardBd">
          <div style="font-weight:1000; margin-bottom:8px">Quick facts</div>
          <div class="note">
            If an action fails, open Console — this page logs the exact endpoint tried and the server response.
            <br><br>
            This page accepts either:
            <br>• <span class="mono">property-admin.html?id=PROPERTY_ID</span>
            <br>• <span class="mono">property-admin.html?slug=PROPERTY_SLUG</span>
          </div>
          <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">
          <div class="note">
            <div><strong>Current query:</strong></div>
            <div class="mono" id="qInfo" style="margin-top:8px;">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="/havn-auth.js"></script>

  <script>
    /* global HAVN_AUTH */
    (function(){
      const API_BASE = "https://api.havn.ie";
      const $ = (id) => document.getElementById(id);

      const els = {
        hero: $("hero"), ttl: $("ttl"), addr: $("addr"),
        statusChip: $("statusChip"),
        typeChip: $("typeChip"), saleChip: $("saleChip"),
        idChip: $("idChip"), slugChip: $("slugChip"),
        created: $("created"), updated: $("updated"),
        thumbs: $("thumbs"),
        loadVia: $("loadVia"), modVia: $("modVia"),
        errBox: $("errBox"), errMsg: $("errMsg"), errPre: $("errPre"),
        toast: $("toast"),
        qInfo: $("qInfo"),
        backBtn: $("backBtn"),
        viewPublicBtn: $("viewPublicBtn"),
        approveBtn: $("approveBtn"),
        rejectBtn: $("rejectBtn"),

        priceVal: $("priceVal"), bedsVal: $("bedsVal"), bathsVal: $("bathsVal"), sizeVal: $("sizeVal"),

        mapQueryLabel: $("mapQueryLabel"),
        mapFrame: $("mapFrame"),

        highlightsChips: $("highlightsChips"),
        highlightsEmpty: $("highlightsEmpty"),
        featuresChips: $("featuresChips"),
        featuresEmpty: $("featuresEmpty"),
        descBox: $("descBox"),
        detailsBox: $("detailsBox"),
      };

      let CURRENT = null;          // current property object
      let CURRENT_ID = "";         // normalized id for actions
      let CURRENT_SLUG = "";       // normalized slug for view public
      let LAST_LOAD_VIA = "—";

      function toast(msg, ms = 2200){
        els.toast.textContent = msg;
        els.toast.classList.add("show");
        window.clearTimeout(toast._t);
        toast._t = window.setTimeout(() => els.toast.classList.remove("show"), ms);
      }

      function safeText(v){ return (v ?? "").toString(); }

      function qs(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      const Q_ID = qs("id") || "";
      const Q_SLUG = qs("slug") || "";
      els.qInfo.textContent = `id=${Q_ID || "—"} | slug=${Q_SLUG || "—"}`;

      function fmtDate(d){
        if (!d) return "—";
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return safeText(d);
        return dt.toLocaleString();
      }

      function dotFor(status){
        const s = safeText(status).toUpperCase();
        if (s === "PUBLISHED") return "g";
        if (s === "REJECTED") return "r";
        if (s === "PENDING") return "y";
        if (s === "DRAFT") return "y";
        return "y";
      }

      function clearErr(){
        els.errBox.style.display = "none";
        els.errMsg.textContent = "";
        els.errPre.textContent = "";
      }
      function showErr(title, msg, details){
        els.errBox.style.display = "block";
        els.errMsg.textContent = (title ? title + " — " : "") + (msg || "Something went wrong.");
        els.errPre.textContent = details || "";
        console.warn("property-admin error:", { title, msg, details });
      }

      async function readJsonSafe(res){
        const text = await res.text().catch(()=> "");
        try { return { text, json: text ? JSON.parse(text) : null }; }
        catch { return { text, json: null }; }
      }

      async function apiFetch(path, opts = {}){
        if (window.HAVN_AUTH && typeof HAVN_AUTH.apiFetch === "function") {
          return HAVN_AUTH.apiFetch(`${API_BASE}${path}`, opts);
        }
        const token = localStorage.getItem("token");
        const headers = Object.assign(
          { "Accept":"application/json", "Content-Type":"application/json" },
          opts.headers || {},
          token ? { Authorization: `Bearer ${token}` } : {}
        );
        return fetch(`${API_BASE}${path}`, Object.assign({}, opts, { headers }));
      }

      function normalizeResponse(data){
        if (Array.isArray(data)) return { items: data, one: data[0] || null };
        const arr =
          (Array.isArray(data?.items) && data.items) ||
          (Array.isArray(data?.properties) && data.properties) ||
          (Array.isArray(data?.results) && data.results) ||
          null;
        if (arr) return { items: arr, one: arr[0] || null };
        const one = data?.property || data?.item || data?.result || null;
        if (one && typeof one === "object") return { items: [one], one };
        if (data && typeof data === "object") return { items: [data], one: data };
        return { items: [], one: null };
      }

      function getHeroUrl(p){
        return safeText(
          p.coverImageUrl ||
          p.heroImageUrl ||
          p.primaryImageUrl ||
          (Array.isArray(p.images) && p.images[0] && (p.images[0].url || p.images[0])) ||
          (Array.isArray(p.photos) && p.photos[0]) ||
          ""
        );
      }

      function getAllImages(p){
        const out = [];
        const candidates = [p.images, p.photos, p.photoUrls, p.imageUrls].filter(Boolean);
        for (const arr of candidates){
          if (Array.isArray(arr)){
            for (const it of arr){
              const url = (it && typeof it === "object") ? (it.url || it.secure_url || it.src) : it;
              if (url) out.push(String(url));
            }
          }
        }
        const hero = getHeroUrl(p);
        if (hero && !out.includes(hero)) out.unshift(hero);
        return out.filter(Boolean).slice(0, 70);
      }

      function getTitle(p){
        return p.title || p.headline || p.addressLine1 || p.address1 || p.address || p.slug || "Untitled";
      }

      function getAddress(p){
        const parts = [
          p.address1 || p.addressLine1,
          p.address2 || p.addressLine2,
          p.city, p.county, p.eircode
        ].map(x => safeText(x).trim()).filter(Boolean);
        return parts.length ? parts.join(", ") : (p.address || p.locationText || "—");
      }

      function getStatus(p){
        return safeText(p.moderationStatus || p.status || p.state || "UNKNOWN").toUpperCase();
      }

      function moneyEUR(n){
        const x = Number(n);
        if (!Number.isFinite(x)) return "—";
        try{
          return x.toLocaleString(undefined, { style:"currency", currency:"EUR", maximumFractionDigits:0 });
        }catch{
          return "€" + Math.round(x).toLocaleString();
        }
      }

      function firstNonEmpty(...vals){
        for (const v of vals){
          const s = safeText(v).trim();
          if (s) return s;
        }
        return "";
      }

      function normalizeArray(v){
        if (Array.isArray(v)) return v.map(x=>safeText(x).trim()).filter(Boolean);
        if (typeof v === "string") return v.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        return [];
      }

      function setChips(container, emptyEl, arr){
        container.innerHTML = "";
        if (!arr.length){
          emptyEl.style.display = "block";
          return;
        }
        emptyEl.style.display = "none";
        for (const t of arr){
          const c = document.createElement("div");
          c.className = "chip2";
          c.textContent = t;
          container.appendChild(c);
        }
      }

      function buildMapQuery(p){
        const eir = firstNonEmpty(p.eircode, p.eirCode, p.postcode, p.zip);
        if (eir) return eir;
        const bits = [
          firstNonEmpty(p.address1, p.addressLine1),
          firstNonEmpty(p.address2, p.addressLine2),
          p.city,
          p.county
        ].map(x => safeText(x).trim()).filter(Boolean);
        return bits.join(", ");
      }

      function renderMap(p){
        const q = buildMapQuery(p);
        els.mapQueryLabel.textContent = q || "—";
        els.mapFrame.src = q ? ("https://www.google.com/maps?q=" + encodeURIComponent(q) + "&output=embed") : "about:blank";
      }

      function setButtonsForStatus(status){
        const s = safeText(status).toUpperCase();
        // Business rules:
        // - Approve is meaningful for PENDING (and maybe REJECTED->approve to publish); keep enabled unless already PUBLISHED
        // - Reject is meaningful unless already REJECTED
        els.approveBtn.disabled = (s === "PUBLISHED");
        els.rejectBtn.disabled  = (s === "REJECTED");
      }

      function renderStatusChip(status){
        const dot = dotFor(status);
        els.statusChip.innerHTML = `<span class="dot ${dot}"></span><span>${status}</span>`;
      }

      function renderProperty(p, via){
        clearErr();
        CURRENT = p;
        LAST_LOAD_VIA = via || "—";

        const title = getTitle(p);
        const addr = getAddress(p);

        // normalize ids
        CURRENT_ID = safeText(p.id ?? p.propertyId ?? p._id ?? Q_ID).trim();
        CURRENT_SLUG = safeText(p.slug ?? Q_SLUG).trim();

        const status = getStatus(p);

        els.ttl.textContent = title;
        els.addr.textContent = addr;

        const hero = getHeroUrl(p);
        if (hero) els.hero.src = hero;

        renderStatusChip(status);

        els.typeChip.textContent = `type: ${safeText(p.propertyType || p.type || "—")}`;
        const listing = firstNonEmpty(p.listingType, p.offerType, p.saleType, p.statusSel, p.listing, p.listingStatus);
        els.saleChip.textContent = `listing: ${listing ? listing : "—"}`;

        els.idChip.textContent = `id: ${CURRENT_ID || "—"}`;
        els.slugChip.textContent = `slug: ${CURRENT_SLUG || "—"}`;

        els.priceVal.textContent = moneyEUR(p.price || p.askingPrice || p.amount);
        els.bedsVal.textContent = safeText(p.bedrooms ?? p.beds ?? "—") || "—";
        els.bathsVal.textContent = safeText(p.bathrooms ?? p.baths ?? "—") || "—";
        const sizeNum = firstNonEmpty(p.size, p.floorArea, p.area);
        const sizeUnit = firstNonEmpty(p.sizeUnit, p.areaUnit, p.unit);
        els.sizeVal.textContent = sizeNum ? (safeText(sizeNum) + (sizeUnit ? (" " + safeText(sizeUnit)) : "")) : "—";

        const highlights = normalizeArray(p.highlights);
        const features = normalizeArray(p.features);
        setChips(els.highlightsChips, els.highlightsEmpty, highlights);
        setChips(els.featuresChips, els.featuresEmpty, features);

        const desc = firstNonEmpty(p.description, p.desc);
        const details = firstNonEmpty(p.details, p.extraDetails, p.additionalDetails);
        els.descBox.textContent = desc ? safeText(desc).replace(/\r\n/g,"\n") : "—";
        els.detailsBox.textContent = details ? safeText(details).replace(/\r\n/g,"\n") : "—";

        renderMap(p);

        els.thumbs.innerHTML = "";
        const imgs = getAllImages(p);
        if (imgs.length){
          const thumbList = imgs.slice(0, 16);
          for (const u of thumbList){
            const d = document.createElement("div");
            d.className = "t";
            d.innerHTML = `<img src="${u}" alt="">`;
            els.thumbs.appendChild(d);
          }
        }

        els.created.textContent = fmtDate(p.createdAt || p.created_at);
        els.updated.textContent = fmtDate(p.updatedAt || p.updated_at);
        els.loadVia.textContent = via || "—";
        els.modVia.textContent = "—";

        // enable view public + actions now
        els.viewPublicBtn.disabled = false;
        setButtonsForStatus(status);

        // wire view public
        els.viewPublicBtn.onclick = () => {
          if (CURRENT_SLUG){
            window.open(`/property.html?slug=${encodeURIComponent(CURRENT_SLUG)}`, "_blank");
          } else if (CURRENT_ID){
            window.open(`/property.html?id=${encodeURIComponent(CURRENT_ID)}`, "_blank");
          } else {
            toast("No slug/id available");
          }
        };
      }

      async function loadFromListAndFind(){
        const listTries = [
          "/api/properties/_admin",
          "/api/admin/properties",
          "/api/properties?scope=admin"
        ];
        let last = null;

        for (const path of listTries){
          try{
            const res = await apiFetch(path);
            if (res.ok){
              const data = await res.json();
              const norm = normalizeResponse(data);
              const items = norm.items || [];
              const idStr = safeText(Q_ID).trim();
              const slugStr = safeText(Q_SLUG).trim().toLowerCase();

              const found = items.find(p => {
                const pid = safeText(p.id ?? p.propertyId ?? p._id).trim();
                const pslug = safeText(p.slug).trim().toLowerCase();
                return (idStr && pid === idStr) || (slugStr && pslug === slugStr);
              });

              if (found){
                console.info("property-admin fallback found in list:", path, found);
                return { p: found, via: path + " (list fallback)" };
              }

              last = { path, note: "List loaded but item not found", count: items.length, q: { id: Q_ID, slug: Q_SLUG } };
            } else {
              const body = await readJsonSafe(res);
              last = { path, status: res.status, body };
            }
          }catch(e){
            last = { path, error: String(e) };
          }
        }

        return { error: last };
      }

      async function loadProperty(){
        clearErr();
        els.viewPublicBtn.disabled = true;
        els.approveBtn.disabled = true;
        els.rejectBtn.disabled = true;

        if (!Q_ID && !Q_SLUG){
          showErr("Missing identifier", "Open this page with ?id=... or ?slug=...", "Example: /property-admin.html?id=YOUR_ID");
          return null;
        }

        const id = Q_ID ? encodeURIComponent(Q_ID) : "";
        const slug = Q_SLUG ? encodeURIComponent(Q_SLUG) : "";

        const tries = [];
        if (id){
          tries.push(`/api/properties/_admin/${id}`);
          tries.push(`/api/properties/_admin?id=${id}`);
          tries.push(`/api/admin/properties/${id}`);
          tries.push(`/api/admin/properties?id=${id}`);
          tries.push(`/api/properties/${id}`);
        }
        if (slug){
          tries.push(`/api/properties/_admin/slug/${slug}`);
          tries.push(`/api/properties/_admin?slug=${slug}`);
          tries.push(`/api/admin/properties/slug/${slug}`);
          tries.push(`/api/admin/properties?slug=${slug}`);
          tries.push(`/api/properties/slug/${slug}`);
          tries.push(`/api/properties?slug=${slug}`);
        }

        let last = null;

        for (const path of tries){
          try{
            const res = await apiFetch(path);
            if (res.ok){
              const data = await res.json();
              const norm = normalizeResponse(data);

              let p = norm.one;

              if (norm.items && norm.items.length > 1){
                const idStr = safeText(Q_ID).trim();
                const slugStr = safeText(Q_SLUG).trim().toLowerCase();
                const match = norm.items.find(x => {
                  const pid = safeText(x.id ?? x.propertyId ?? x._id).trim();
                  const pslug = safeText(x.slug).trim().toLowerCase();
                  return (idStr && pid === idStr) || (slugStr && pslug === slugStr);
                });
                if (match) p = match;
              }

              if (p && typeof p === "object"){
                console.info("property-admin load ok via:", path, p);
                return { p, via: path };
              }

              last = { path, note:"OK response but no property extracted", keys:Object.keys(data||{}), sample:data };
            } else {
              const body = await readJsonSafe(res);
              last = { path, status: res.status, body };
            }
          }catch(e){
            last = { path, error: String(e) };
          }
        }

        const fb = await loadFromListAndFind();
        if (fb && fb.p) return fb;

        showErr("Load failed", "Could not extract property from API responses.", JSON.stringify(fb?.error || last, null, 2));
        toast("Load failed — check console");
        return null;
      }

      function setActionBusy(on){
        els.approveBtn.disabled = on || els.approveBtn.disabled;
        els.rejectBtn.disabled  = on || els.rejectBtn.disabled;
        els.viewPublicBtn.disabled = on || els.viewPublicBtn.disabled;
      }

      async function tryActionSequence(label, steps){
        let last = null;

        for (const step of steps){
          try{
            const res = await apiFetch(step.path, {
              method: step.method,
              headers: step.headers || undefined,
              body: step.body ? JSON.stringify(step.body) : undefined
            });

            const body = await readJsonSafe(res);
            last = { step, status: res.status, body };

            console.info(`[${label}] tried`, step.method, step.path, "=>", res.status, body.json || body.text);

            if (res.ok){
              return { ok: true, step, status: res.status, body };
            }
          }catch(e){
            last = { step, error: String(e) };
          }
        }

        return { ok: false, last };
      }

      function computePublishStatus(){
        // our UI should reflect the moderation outcome
        return "PUBLISHED";
      }
      function computeRejectStatus(){
        return "REJECTED";
      }

      async function approveProperty(){
        clearErr();
        if (!CURRENT || !CURRENT_ID){
          toast("Missing property id");
          return;
        }

        const currentStatus = getStatus(CURRENT);
        if (currentStatus === "PUBLISHED"){
          toast("Already published");
          return;
        }

        if (!confirm("Approve this listing?\n\nThis should mark it as PUBLISHED and make it publicly visible.")) return;

        setActionBusy(true);
        toast("Approving…");

        const id = encodeURIComponent(CURRENT_ID);

        // Try the most likely moderation endpoints first, then fall back to PATCH status updates.
        const steps = [
          { method: "POST", path: `/api/properties/_admin/${id}/approve` },
          { method: "POST", path: `/api/properties/_admin/approve/${id}` },
          { method: "POST", path: `/api/admin/properties/${id}/approve` },
          { method: "POST", path: `/api/properties/${id}/approve` },
          { method: "POST", path: `/api/properties/approve/${id}` },

          // Generic moderate endpoints
          { method: "POST", path: `/api/properties/_admin/${id}/moderate`, body: { action: "APPROVE" } },
          { method: "POST", path: `/api/admin/properties/${id}/moderate`, body: { action: "APPROVE" } },
          { method: "POST", path: `/api/properties/${id}/moderate`, body: { action: "APPROVE" } },

          // PATCH-based fallback
          { method: "PATCH", path: `/api/properties/_admin/${id}`, body: { moderationStatus: "PUBLISHED" } },
          { method: "PATCH", path: `/api/admin/properties/${id}`, body: { moderationStatus: "PUBLISHED" } },
          { method: "PATCH", path: `/api/properties/${id}`, body: { moderationStatus: "PUBLISHED" } },
        ];

        const out = await tryActionSequence("APPROVE", steps);

        if (!out.ok){
          const d = JSON.stringify(out.last, null, 2);
          showErr("Approve failed", "Could not approve property.", d);
          toast("Approve failed — check console");
          setActionBusy(false);
          els.modVia.textContent = "—";
          return;
        }

        // Update UI locally
        const newStatus = computePublishStatus();
        CURRENT.moderationStatus = newStatus;
        CURRENT.status = CURRENT.status || CURRENT.moderationStatus;

        renderStatusChip(newStatus);
        setButtonsForStatus(newStatus);

        els.modVia.textContent = `${out.step.method} ${out.step.path}`;
        toast("Approved ✅");

        // optional refresh from server to ensure consistency
        setTimeout(async () => {
          const loaded = await loadProperty();
          if (loaded && loaded.p) renderProperty(loaded.p, loaded.via);
        }, 400);

        setActionBusy(false);
      }

      async function rejectProperty(){
        clearErr();
        if (!CURRENT || !CURRENT_ID){
          toast("Missing property id");
          return;
        }

        const currentStatus = getStatus(CURRENT);
        if (currentStatus === "REJECTED"){
          toast("Already rejected");
          return;
        }

        const reason = prompt("Reject this listing?\n\nOptional: enter a short reason (Cancel to abort).", "");
        if (reason === null) return;

        setActionBusy(true);
        toast("Rejecting…");

        const id = encodeURIComponent(CURRENT_ID);

        const steps = [
          { method: "POST", path: `/api/properties/_admin/${id}/reject`, body: reason ? { reason } : undefined },
          { method: "POST", path: `/api/properties/_admin/reject/${id}`, body: reason ? { reason } : undefined },
          { method: "POST", path: `/api/admin/properties/${id}/reject`, body: reason ? { reason } : undefined },
          { method: "POST", path: `/api/properties/${id}/reject`, body: reason ? { reason } : undefined },
          { method: "POST", path: `/api/properties/reject/${id}`, body: reason ? { reason } : undefined },

          // Generic moderate endpoints
          { method: "POST", path: `/api/properties/_admin/${id}/moderate`, body: { action: "REJECT", ...(reason ? { reason } : {}) } },
          { method: "POST", path: `/api/admin/properties/${id}/moderate`, body: { action: "REJECT", ...(reason ? { reason } : {}) } },
          { method: "POST", path: `/api/properties/${id}/moderate`, body: { action: "REJECT", ...(reason ? { reason } : {}) } },

          // PATCH-based fallback
          { method: "PATCH", path: `/api/properties/_admin/${id}`, body: { moderationStatus: "REJECTED", ...(reason ? { rejectionReason: reason } : {}) } },
          { method: "PATCH", path: `/api/admin/properties/${id}`, body: { moderationStatus: "REJECTED", ...(reason ? { rejectionReason: reason } : {}) } },
          { method: "PATCH", path: `/api/properties/${id}`, body: { moderationStatus: "REJECTED", ...(reason ? { rejectionReason: reason } : {}) } },
        ];

        const out = await tryActionSequence("REJECT", steps);

        if (!out.ok){
          const d = JSON.stringify(out.last, null, 2);
          showErr("Reject failed", "Could not reject property.", d);
          toast("Reject failed — check console");
          setActionBusy(false);
          els.modVia.textContent = "—";
          return;
        }

        const newStatus = computeRejectStatus();
        CURRENT.moderationStatus = newStatus;

        renderStatusChip(newStatus);
        setButtonsForStatus(newStatus);

        els.modVia.textContent = `${out.step.method} ${out.step.path}`;
        toast("Rejected ✅");

        setTimeout(async () => {
          const loaded = await loadProperty();
          if (loaded && loaded.p) renderProperty(loaded.p, loaded.via);
        }, 400);

        setActionBusy(false);
      }

      async function boot(){
        if (window.HAVN_AUTH && typeof HAVN_AUTH.requireAuth === "function") {
          HAVN_AUTH.requireAuth({ next: window.location.pathname + window.location.search });
        } else {
          const t = localStorage.getItem("token");
          if (!t){
            const next = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `/login.html?next=${next}`;
            return;
          }
        }

        els.backBtn.onclick = () => window.location.href = "/admin.html";

        const loaded = await loadProperty();
        if (!loaded) return;

        renderProperty(loaded.p, loaded.via);

        // Step 2 handlers
        els.approveBtn.onclick = approveProperty;
        els.rejectBtn.onclick = rejectProperty;
      }

      boot();
    })();
  </script>
</body>
</html>
